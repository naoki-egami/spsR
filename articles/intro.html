<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="spsR">
<title>Introduction to SPS • spsR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to SPS">
<meta property="og:description" content="spsR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">spsR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/intro.html">Get Started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/practical_guides.html">Practical Guides</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-more">More</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-more">
    <a class="dropdown-item" href="../articles/prepare_data.html">1. Prepare Country-Level Variables</a>
    <a class="dropdown-item" href="../articles/missing_data.html">2. Handle Missing Data</a>
    <a class="dropdown-item" href="../articles/stratify_sps.html">3. Stratified SPS</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Introduction to SPS</h1>
            
      
      
      <div class="d-none name"><code>intro.Rmd</code></div>
    </div>

    
    
<p><br></p>
<p class="h5">
<strong>On this page, we provide the introduction to <code>spsR</code>
package (10 minute read).</strong>
</p>
<br><div class="card bg-light mb-3">
<div class="card-header">
<strong>Table of Contents</strong>
</div>
<div class="card-body">
<ol style="list-style-type: decimal">
<li><p><a href="#step"><strong>Overview</strong></a>: <br> We provide
the overview of <code>spsR</code> package.</p></li>
<li><p><a href="#example"><strong>Example: Multi-Country Survey
Experiment</strong></a>: <br> We introduce an illustraitve example and
its data set.</p></li>
<li><p><a href="#sps"><strong><code>sps</code>: Site
Selection</strong></a>: <br> We explain how to use function
<code><a href="../reference/sps.html">sps()</a></code> for site selection</p></li>
<li><p><a href="#sps_estimator"><strong><code>sps_estimator</code>:
Estimate the Average-Site ATE</strong></a>: <br> We explain how to use
function <code><a href="../reference/sps_estimator.html">sps_estimator()</a></code> to analyze multi-site
studies.</p></li>
</ol>
</div>
</div>
<p><br></p>
<div class="section level3">
<h3 id="over">
<span style="color:#3366CC"><strong>1.
 Overview</strong></span><a class="anchor" aria-label="anchor" href="#over"></a>
</h3>
<p class="lh-lg">
</p>
<p>External validity of causal findings is a focus of long-standing
debates. Whether and how can researchers generalize causal findings
across different contexts and settings? To address this question, an
increasing number of researchers use <strong>a multi-site/multi-context
design</strong> where researchers conduct causal studies in multiple
sites to compare and aggregate findings across contexts.</p>
<p>When designing multi-site experiments (or observational studies), the
fundamental research design question is <strong>how should we select
study sites for external validity?</strong></p>
<p>The R package <code>spsR</code> aims to help researchers
<strong>select sites for external validity with statistical foundation,
while accommodating practical and logistical constraints</strong>.</p>
<p>In particular, <code>spsR</code> implements Synthetic Purposive
Sampling (SPS) introduced in <a href="https://naokiegami.com/paper/sps.pdf" class="external-link">Egami and Lee (2023+)</a>,
which improves upon conventional purposive sampling by combining ideas
from the synthetic control method — it selects diverse sites such that
non-selected sites are well approximated by the weighted average of the
selected sites. By doing so, even without random sampling, we can make
the weighted average of selected sites representative of all the sites,
including non-selected sites in the population of sites. Please read <a href="https://naokiegami.com/paper/sps.pdf" class="external-link">Egami and Lee (2023+)</a>
for the methodological details.</p>
<p>Using <code>spsR</code>, researchers can</p>
<ul>
<li>Select diverse sites based on the SPS framework</li>
<li>Estimate the average causal effect for the population of sites</li>
</ul>
<!-- On this page, we introduce the basic functionalities that is likely to be sufficient for most users, most of the time. For users who need more advanced functionalities, we offer AAA.  --><p><br></p>
</div>
<div class="section level3">
<h3 id="example">
<span style="color:#3366CC"><strong>2.  Example: Multi-Country
Survey Experiment</strong></span><a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p class="lh-lg">
</p>
<p>We use a multi-country survey experiment on attitudes toward
immigrants (Naumann et al., 2018) as an example here. This study aims to
answer a long-standing question in the immigration literature—whether
and how much do natives prefer highly skilled migrants to low skilled
migrants? To do so, in each site, they conduct a survey experiment where
they randomly varied the skill level of hypothetical immigrant groups,
i.e., “professionals” or “unskilled labors” (treatment variable), and
asked respondents to report the support level for this immigrant group
(outcome variable).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://naokiegami.com/spsR/">spsR</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"X_Imm"</span><span class="op">)</span></span></code></pre></div>
<p>In this example, we try to select 6 countries from 15 European
countries as study sites for the multi-site survey experiment.</p>
<p>When selecting study sites for multi-site experiments, we choose
site-level variables that we want to diversify. For example, to
understand whether causal findings vary across different contexts,
researchers might include diverse countries with different GDP, size of
migrant population, unemployment rates, and so on. More formally,
researchers should choose site-level variables that predict across-site
heterogeneity of causal effects.</p>
<p>In this illustration, we consider 8 variables discussed in the
original paper: GDP (<code>GDP</code>), unemployment rates
(<code>Unemployment</code>), size of migrant population
(<code>Immigration</code>), the proportion of females
(<code>Female</code>), the mean age (<code>Age</code>), the mean
education (<code>Education</code>), general support for immigration
(<code>Immig_Support</code>), and sub-regions in Europe
(<code>Eastern Europe</code>, <code>Northern Europe</code>,
<code>Southern Europe</code>, <code>Western Europe</code>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X_Imm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "GDP"             "Unemployment"    "Immigration"     "Female"         </span></span>
<span><span class="co">##  [5] "Age"             "Education"       "Immig_Support"   "Eastern Europe" </span></span>
<span><span class="co">##  [9] "Northern Europe" "Southern Europe" "Western Europe"</span></span></code></pre>
<p>In practice, it is recommended to standardize each continuous
variable to make the scale of site-level variables comparable. That is,
each variable has the mean zero and the standard deviation one.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_cont</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'GDP'</span>, <span class="st">'Unemployment'</span>, <span class="st">'Immigration'</span>, </span>
<span>               <span class="st">'Female'</span>, <span class="st">'Age'</span>, <span class="st">'Education'</span>, <span class="st">'Immig_Support'</span><span class="op">)</span></span>
<span><span class="va">X_Imm</span><span class="op">[</span>, <span class="va">var_cont</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_Imm</span><span class="op">[</span>, <span class="va">var_cont</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">X_Imm</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                GDP Unemployment Immigration Female    Age Education</span></span>
<span><span class="co">## Austria     -0.528       -0.511       0.698 -0.029  0.032    -1.747</span></span>
<span><span class="co">## Belgium     -0.453        0.117      -0.202 -0.615 -1.019     0.522</span></span>
<span><span class="co">## Switzerland -0.236       -0.720       2.769 -0.927 -0.734    -0.669</span></span>
<span><span class="co">## Czechia     -0.710       -0.663      -1.668  0.672 -1.446     0.170</span></span>
<span><span class="co">## Germany      2.259       -0.761       0.249 -0.661  0.396     0.288</span></span>
<span><span class="co">## Denmark     -0.602       -0.384      -0.582 -1.306 -0.581     0.609</span></span>
<span><span class="co">##             Immig_Support Eastern Europe Northern Europe Southern Europe</span></span>
<span><span class="co">## Austria            -0.664              0               0               0</span></span>
<span><span class="co">## Belgium            -0.226              0               0               0</span></span>
<span><span class="co">## Switzerland         0.530              0               0               0</span></span>
<span><span class="co">## Czechia            -2.276              1               0               0</span></span>
<span><span class="co">## Germany             1.158              0               0               0</span></span>
<span><span class="co">## Denmark             0.444              0               1               0</span></span>
<span><span class="co">##             Western Europe</span></span>
<span><span class="co">## Austria                  1</span></span>
<span><span class="co">## Belgium                  1</span></span>
<span><span class="co">## Switzerland              1</span></span>
<span><span class="co">## Czechia                  0</span></span>
<span><span class="co">## Germany                  1</span></span>
<span><span class="co">## Denmark                  0</span></span></code></pre>
<p>Users can use <code><a href="../reference/sps_plot.html">sps_plot()</a></code> to visualize the distribution
of site-level variables before site selection. We select the first
several variables that are continuous.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sps_plot.html">sps_plot</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, before_selection <span class="op">=</span> <span class="cn">TRUE</span>, columns <span class="op">=</span> <span class="va">var_cont</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;"><br></p>
</div>
<div class="section level3">
<h3 id="sps">
<span style="color:#3366CC"><strong>3.  <code>sps</code>: Site
Selection</strong></span><a class="anchor" aria-label="anchor" href="#sps"></a>
</h3>
<p class="lh-lg">
</p>
<p>We can use <code><a href="../reference/sps.html">sps()</a></code> to select 6 sites from 15 European
countries (the population of sites). We start with the basic version of
<code>sps</code> and illustrate refinements next.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, N_s <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Selecting Study Sites...</span></span></code></pre>
<p><strong>Arguments</strong></p>
<ul>
<li>
<code>X</code>: Site-level variables for the population of sites.
Row names should be names of sites.</li>
<li>
<code>N_s</code>: Number of study sites to be selected.</li>
</ul>
<p>In this example, <code>sps</code> selected the following 6 sites.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span><span class="op">$</span><span class="va">selected_sites</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Switzerland" "Czechia"     "Germany"     "Denmark"     "Spain"      </span></span>
<span><span class="co">## [6] "Netherlands"</span></span></code></pre>
<p>Users can investigate the selected sites visually using
<code><a href="../reference/sps_plot.html">sps_plot()</a></code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sps_plot.html">sps_plot</a></span><span class="op">(</span><span class="va">out</span>, columns <span class="op">=</span> <span class="va">var_cont</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Red triangles represent selected sites and black circles represent
non-selected sites. In the last row and the diagonal plots, users can
see the marginal distribution of each variable. All the remaining
figures in the middle show bivariate relationships between two
variables.</p>
<p>We can see that selected sites successfully cover a wide range of
values in each site-level variable.</p>
<p>If necessary, users can refine site selection using
<em>stratification</em> to make sure selected sites satisfy certain
conditions. This stratification can help users to incorporate various
practical, logistical, and ethical constraints. See some examples
below.</p>
<details><summary><span style="color:#3366CC"><tag class="h4"><strong>Stratify
SPS</strong></tag></span>
</summary><p>In practice, researchers might want to stratify some variables to
make sure that study sites satisfy certain conditions.</p>
<div class="section level4">
<h4 id="example-1-improve-diversity-of-site-level-variables">
<span style="color:#3366CC">Example 1: Improve Diversity of
Site-Level Variables</span><a class="anchor" aria-label="anchor" href="#example-1-improve-diversity-of-site-level-variables"></a>
</h4>
<p class="lh-lg">
</p>
<p>It is often useful to select sites that have high, middle, low values
in some site-level variables. For example, users might want to make sure
that we select at least one country from low, medium, and high GDP
countries.</p>
<p>Users can enforce this condition using
<code>stratify_sps().</code></p>
<p>To select countries with high GDP, we might want to select
<code>at least</code> <code>2</code> sites that have <code>GDP</code>
<code>larger than or equal to</code> <code>0.5</code> (i.e., 0.5
standard deviation because we standardized above). We can incorporate
this information as follows.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_GDP_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, </span>
<span>                         num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>                         condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"GDP"</span>, <span class="st">"larger than or equal to"</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 3 sites satisfy the specified `condition` and sps() will select at least 2 sites from them.</span></span></code></pre>
<p>To select countries with medium GDP, we might want to select
<code>at least</code> <code>2</code> sites that have <code>GDP</code>
<code>between</code> <code>c(-0.25, 0.25)</code> (i.e., between -0.25
and 0.25 standard deviation).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_GDP_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, </span>
<span>                         num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>                         condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"GDP"</span>, <span class="st">"between"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 3 sites satisfy the specified `condition` and sps() will select at least 2 sites from them.</span></span></code></pre>
<p>Finally, to select countries with low GDP, we might want to select
<code>at least</code> <code>2</code> sites that have <code>GDP</code>
<code>smaller than or equal to</code> <code>-0.5</code> (i.e., -0.5
standard deviation).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_GDP_3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, </span>
<span>                         num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>                         condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"GDP"</span>, <span class="st">"smaller than or equal to"</span>, <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 7 sites satisfy the specified `condition` and sps() will select at least 2 sites from them.</span></span></code></pre>
<p><strong>Arguments</strong></p>
<ul>
<li><p><code>num_site</code>: A list of two elements, e.g.,
<code>list("at least", 1)</code>. This argument specifies the number of
sites that should satisfy <code>condition</code> specified below. The
first element should be either <code>at least</code> or
<code>at most</code>. The second element is integer. For example,
<code>list("at least", 1)</code> means that we stratify SPS such that we
select <em>at least 1</em> site that satisfies <code>condition</code>
(specified below).</p></li>
<li><p><code>condition</code>: A list of three elements, e.g.,
<code>list("GDP", "larger than or equal to", 1)</code>. This argument
specifies conditions for stratification. The first element should be a
name of a site-level variable. The second element should be either
<code>larger than or equal to</code>,
<code>smaller than or equal to</code>, or <code>between</code>. The
third element is a vector of length 1 or 2. When the second element is
<code>between</code>, the third element should be a vector of two
values. For example,
<code>list("GDP", "larger than or equal to", 1)</code> means that we
stratify SPS such that we select <code>num_site</code> sites that have
<em>GDP larger than or equal to 1</em>.</p></li>
</ul>
<p>After specifying these staratification, researchers can supply them
to <code><a href="../reference/sps.html">sps()</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_GDP</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, </span>
<span>               N_s <span class="op">=</span> <span class="fl">6</span>, </span>
<span>               stratify <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">st_GDP_1</span>, <span class="va">st_GDP_2</span>, <span class="va">st_GDP_3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Selecting Study Sites...</span></span></code></pre>
<p><strong>Arguments</strong></p>
<ul>
<li>
<code>stratify</code>: A <code>list</code> where each element is an
output from function <code><a href="../reference/stratify_sps.html">stratify_sps()</a></code>.</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_GDP</span><span class="op">$</span><span class="va">selected_sites</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Switzerland"    "Czechia"        "Denmark"        "Spain"         </span></span>
<span><span class="co">## [5] "France"         "United Kingdom"</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="example-2-select-countries-from-each-sub-region">
<span style="color:#3366CC">Example 2: Select Countries from Each
Sub-Region</span><a class="anchor" aria-label="anchor" href="#example-2-select-countries-from-each-sub-region"></a>
</h4>
<p class="lh-lg">
</p>
<p>It is often useful to select sites from different subgroups. For
example, users might want to make sure that we select at least one
country from each of 4 sub-regions of Europe.</p>
<p>The following code ensures to select <code>at least</code>
<code>1</code> site from countries that have
<code>Northern Europe = 1</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_NE</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X_Imm</span>, </span>
<span>               num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>               condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Northern Europe"</span>, <span class="st">"larger than or equal to"</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 6 sites satisfy the specified `condition` and sps() will select at least 1 site from them.</span></span></code></pre>
<p>Similarly, the following codes ensure that we select
<code>at least</code> <code>1</code> site from countries that have
<code>Eastern Europe = 1</code>, <code>Western Europe = 1</code> and
<code>Southern Europe = 1</code>, respectively.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_EE</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X_Imm</span>, </span>
<span>               num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>               condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Eastern Europe"</span>, <span class="st">"larger than or equal to"</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 1 site satisfies the specified `condition` and sps() will select at least 1 site from them.</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_WE</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X_Imm</span>, </span>
<span>               num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>               condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Western Europe"</span>, <span class="st">"larger than or equal to"</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 6 sites satisfy the specified `condition` and sps() will select at least 1 site from them.</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_SE</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/stratify_sps.html">stratify_sps</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">X_Imm</span>, </span>
<span>               num_site<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"at least"</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>               condition<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Southern Europe"</span>, <span class="st">"larger than or equal to"</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 2 sites satisfy the specified `condition` and sps() will select at least 1 site from them.</span></span></code></pre>
<p>Finally, users combine them into one <code>list</code> and supply it
to function <code><a href="../reference/sps.html">sps()</a></code>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_region</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps.html">sps</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">X_Imm</span>, </span>
<span>                  N_s <span class="op">=</span> <span class="fl">6</span>, </span>
<span>                  stratify <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">st_NE</span>, <span class="va">st_EE</span>, <span class="va">st_WE</span>, <span class="va">st_SE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Selecting Study Sites...</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_region</span><span class="op">$</span><span class="va">selected_sites</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Switzerland" "Czechia"     "Germany"     "Denmark"     "Spain"      </span></span>
<span><span class="co">## [6] "Netherlands"</span></span></code></pre>
<p>Please see <a href="http://naokiegami.com/spsR/articles/stratify_sps.html">Stratified
SPS</a> for practical recommendations about stratification.</p>
<!-- We can also visualize it.  -->
<!-- ```{r, fig.dim = c(7, 7), fig.align = 'center'} -->
<!-- sps_plot(out_region) -->
<!-- ``` -->

</div>
</details>
</div>
<div class="section level3">
<h3 id="sps_estimator">
<span style="color:#3366CC"><strong>4.  <code>sps_estimator</code>:
Estimate the Average-Site ATE</strong></span><a class="anchor" aria-label="anchor" href="#sps_estimator"></a>
</h3>
<p class="lh-lg">
</p>
<p>Once we complete a randomized experiment (or an internally valid
observational study) in each site, we now aggregate evidece for external
validity.</p>
<p><code><a href="../reference/sps_estimator.html">sps_estimator()</a></code> will aggregate estimates of the average
treatment effects (ATEs) in each specific site in order to estimate the
average-site ATE (the average of the ATEs in the population of sites).
In our example, the average-site ATE is the average of the ATEs across
15 European countries, including countries that were not selected.</p>
<p>We start with ATE estimates in the selected sites. We use
experimental estimates in selected 6 sites from Naumann et al (2018).
Users only need to obtain point estimates and standard errors of the
average treatment effects (ATEs) in each site. As an example, we use
selected sites from <code>out</code>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"exp_estimate_Imm_selected"</span><span class="op">)</span></span>
<span><span class="va">exp_estimate_Imm_selected</span></span></code></pre></div>
<pre><code><span><span class="co">##              Estimate Std. Error</span></span>
<span><span class="co">## Netherlands 0.3034004 0.02294807</span></span>
<span><span class="co">## Germany     0.3362153 0.01635270</span></span>
<span><span class="co">## Denmark     0.2936739 0.02520817</span></span>
<span><span class="co">## Spain       0.2831690 0.02368973</span></span>
<span><span class="co">## Switzerland 0.2857338 0.02715871</span></span>
<span><span class="co">## Czechia     0.2210802 0.01993582</span></span></code></pre>
<p>For external validity analysis, we then aggregate these site-specific
ATEs in selected sites to estimate the average-site ATE.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps_estimator.html">sps_estimator</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">out</span>, </span>
<span>                         estimates_selected <span class="op">=</span> <span class="va">exp_estimate_Imm_selected</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sps_est2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps_estimator.html">sps_estimator</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">internal</span><span class="op">$</span><span class="va">X</span>, estimates_selected <span class="op">=</span> <span class="va">exp_estimate_Imm_selected</span>, </span>
<span>                          selected_sites <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">selected_sites</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sps_est</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##   Estimate Std. Error  CI Lower  CI Upper p value    </span></span>
<span><span class="co">##  0.2888706 0.01957847 0.2504975 0.3272437       0 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sps_est2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##   Estimate Std. Error  CI Lower  CI Upper p value    </span></span>
<span><span class="co">##  0.2888706 0.01957847 0.2504975 0.3272437       0 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<p><strong>Arguments</strong></p>
<ul>
<li>
<code>out</code>: Output from function <code><a href="../reference/sps.html">sps()</a></code>
</li>
<li>
<code>estimates_selected</code>: <code>data.frame</code> with two
columns: the first column represents estimates of the site-specific ATEs
for the selected sites and the second column represents its
corresponding standard error. The number of rows is equal to the number
of the selected sites and <code>rownames(estimates_selected)</code>
should be names of the selected sites.</li>
</ul>
<p>We can check the results using <code>summary</code> function.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sps_est</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##   Estimate Std. Error  CI Lower  CI Upper p value    </span></span>
<span><span class="co">##  0.2888706 0.01957847 0.2504975 0.3272437       0 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes: 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre>
<p>We can also visualize both site-specific ATEs and the average-site
ATE together using <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sps_est</span><span class="op">)</span></span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>Finally, users can use site-level cross-validation to assess the
influence of unobserved moderators. In particular, users can randomly
choose half of the selected sites as if they were unobserved
non-selected sites and predict the average ATE of those non-selected
sites based on the remaining selected sites. The null hypothesis is that
the predicted ATEs are the same as the observed ATEs.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sps_cv_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sps_cv.html">sps_cv</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">out</span>, estimates_selected <span class="op">=</span> <span class="va">exp_estimate_Imm_selected</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">sps_cv_out</span><span class="op">$</span><span class="va">p_value</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.94</span></span></code></pre>
<p>In this example, an estimated p-value is 0.94, and we do not find
evidence for the bias due to unobserved moderators.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Naoki Egami, Diana Da In Lee.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
