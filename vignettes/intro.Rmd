---
title: "Introduction to sps"
output: 
  md_document:
    variant: markdown_github
---

### Overview 

On this page, we provide the introduction to `sps` package (5 minute read). 

Specifically, we explain the two main functions. 

1. `sps`: Synthetic Purposive Sampling to select study sites for multi-site causal studies. 

2. `sps_estimator`: Synthetic Purposive Sampling Estimator to estimate the average-site average treatment effect (ATEs) from multi-site causal studies. 

<br>


### `sps`: Site Selection

We use a multi-country survey experiment on attitudes toward immigrants (Naumann et al, 2018) as an example here. 

In this example, we define 15 European countries as the population of sites. As site-level variables, we consider 7 variables discussed in the original paper: GDP, size of migrant population, unemployment rates, general support for immigration, the proportion of females, the mean age, and the mean income. 

```{r, eval = TRUE, echo = TRUE, tidy=FALSE, warning=FALSE, error=FALSE, message=FALSE}
library(spsR)
data("X_Imm")
dim(X_Imm)
```

In practice, it is recommended to standardize each variable to make the scale of site-level variables comparable. That is, each variable has the mean zero and the standard deviation one.  

```{r}
X_Imm <- scale(X_Imm)
round(head(X_Imm), 3)
```

Users can use `sps_plot()` to visualize the distribution of site-level variables before site selection. 

```{r, fig.dim = c(7, 7), fig.align = 'center'}
sps_plot(X = X_Imm, before_selection = TRUE)
```

We can then use `sps` to select diverse sites from the population of sites. We will select 6 sites from 15 European countries in this example.^[*Note*: Given that the underlying optimization problem is a mixed-integer problem, the function usually takes less than 30 secs to complete in typical problems in political science and related social science fields (e.g., select 5 ~ 10 sites out of 15 ~ 30 sites). If users want to select a larger number of sites from a larger population of sites, it might take more time.] We start with the basic version of `sps` and illustrate refinements on different pages (e.g., the stratified SPS). 

```{r}
out <- sps(X = X_Imm, N_s = 6)
```

In this example, `sps` selected the following 6 sites.

```{r}
out$selected_sites
```

Users can investigate the selected sites visually. Red triangles represent selected sites and black circles represent non-selected sites. In the last row and the diagonal plots, users can see the marginal distribution of each variable. All the remaining figures in the middle show bivariate relationships between two variables. 

We can see that selected sites successfully cover a wide range of values in each site-level variable. 

```{r, fig.dim = c(7, 7), fig.align = 'center'}
sps_plot(out)
```

If necessary, users can refine site selection using *stratification* to make sure selected sites satisfy certain conditions. This stratification can help users to incorporate various practical, logistical, and ethical constraints. Please see AAA. 

<br>


### `sps_estimator`: Estimate the Average-Site ATE

We focus on a multi-site causal study where where researchers have (experimental or observational) identification strategies for internal validity within each site and researchers compare results across sites for external validity. `sps_estimator` will aggregate site-specific ATE estimates to estimate the average-site ATE. 

Here, we use experimental estimates in selected 6 sites from Naumann et al (2018). Users only need to obtain point estimates and standard errors of the average treatment effects (ATEs) in each site. 

```{r}
data("exp_estimate_Imm_selected")
exp_estimate_Imm_selected
```

We then aggregate these site-specific ATEs in selected sites to estimate the average-site ATE. 

```{r}
sps_est <- sps_estimator(out = out, estimates_selected = exp_estimate_Imm_selected)

summary(sps_est)
```

Finally, users can use site-level cross-validation to assess the influence of unobserved moderators. In particular, users can randomly choose half of the selected sites as if they were unobserved non-selected sites and predict the average ATE of those non-selected sites based on the remaining selected sites. The null hypothesis is that the predicted ATEs are the same as the observed ATEs. 

```{r}
sps_cv_out <- sps_cv(out = out, estimates_selected = exp_estimate_Imm_selected)
round(sps_cv_out$p_value, 2)
```

In this example, an estimated p-value is `r round(sps_cv_out$p_value, 2)`, and we do not find evidence for the bias due to unobserved moderators. 
