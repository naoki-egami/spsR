---
title: "Prepare Site-Level Variables"
output: 
  md_document:
    variant: markdown_github
always_allow_html: yes
---

# Prepare Site-Level Variables

```{r}
library(spsRdata)
library(spsR)
```

We provide a dataset (`sps_data`) comprised of 21 country-level variables for 179 countries between 2015 and 2022. It contains covariates representing political, economic, and social characteristics of countries in the dataset, collected from three sources: V-DEM, World Bank Indicators, and Resource Watch: 

* [Varieties of Democracy (V-Dem) project](https://v-dem.net/data/the-v-dem-dataset): collects democracy ratings for all countries in the world.

* [World Bank Indicators](https://datahelpdesk.worldbank.org/knowledgebase/articles/889392-about-the-indicators-api-documentation): include economic (e.g., GDP, unemployment), demographic (e.g., population, education, migration), geographic (e.g., land area), and political (e.g., government spending) indicators for all countries in the world. 

* [University of Groningen's World Languages](https://resourcewatch.org/data/explore/soc_071_world_languages?section=Discover&selectedCollection=&zoom=3&lat=0&lng=0&pitch=0&bearing=0&basemap=dark&labels=light&layers=%255B%257B%2522dataset%2522%253A%252220662342-dcdd-4a42-9f58-bcc80217de71%2522%252C%2522opacity%2522%253A1%252C%2522layer%2522%253A%2522f2d76e6b-060d-4dc9-83ea-284bef6b2aae%2522%257D%255D&aoi=&page=1&sort=most-viewed&sortDirection=-1): World langauges dataset created using CIA World Factbook.

 <!-- Add text describing data and codebook -->

```{r}
data(sps_data)
head(sps_data)

data(codebook)
head(codebook)
```
<!-- need to check if tidyverse is needed elsewher -->

```{r, echo = F}
library(kableExtra)
library(knitr)
kbl(codebook,
      label = "tab:codebook",
      caption = "List of Selected Variables") %>%
  kable_classic_2(full_width = T) %>%
  kable_styling(font_size = 12, bootstrap_options = c('hover', 'condensed')) %>%
  column_spec(1, italic = T) %>%
  pack_rows('Key Identifiers', 1, 3) %>%
  pack_rows('Geographic Indicators', 4, 5) %>%
  pack_rows('Democracy Indicators', 6, 8) %>%
  pack_rows('Political Indicators', 9, 14) %>%
  pack_rows('Economic Indicators', 15, 16) %>%
  pack_rows('Sociodemographic Indicators', 17, 19) %>%
  pack_rows('Social Indicators', 20, 21)
```

### Search for and Add New Variables

You can also search for other variables in the V-Dem dataset and World Bank using keywords via the function ``search_var``. For example:

```{r}
search_result <- search_var(keyword = 'international migrant')
head(search_result, n = 3)
```

Based on the search return, you can decide to add the variable(s) to the baseline dataset using the function ``add_var``. For example:

```{r}
sps_data1 <- add_var(data = sps_data, vars = c('SM.POP.TOTL.ZS'))
head(sps_data1, n = 3)
```

### Merge Your Own Dataset {.tabset .tabset-dropdown}

#### Dropdown 1

You can also merge your own dataset using the function ``merge_data``. If your own dataset has an ISO3 code, it merges your dataset using the ISO3 code via an exact match. If your dataset has a country name variable instead, it first merges via an exact match based on the country name, followed by a [fuzzy-match](https://github.com/dgrtwo/fuzzyjoin). For example, 

<!-- Re-create with ESS dataset with country and year already created -->

```{r, echo = F}
naumann <- as.data.frame(X_Imm) %>% tibble::rownames_to_column() %>% dplyr::select(-GDP, -Unemp., -Immigration, -rowname) %>% dplyr::rename_all(tolower) 
naumann$cntry <- c("The Netherlands","Sweden","Norway","France","Germany","Bellgium","Denmark","Finland","Ireland","Slovenia","Spain","Switzerland","Austria","Czech","United Kingdom")
naumann$yr    <- 2015
naumann <- dplyr::select(naumann, cntry, yr, everything())
head(naumann)
```

<!-- Simplify the code in presenting the merged result -->
```{r}
sps_data2 <- merge_data(basedata = sps_data1, newdata = naumann, yearvar = 'yr', countryvar = 'cntry', iso = FALSE)

sps_data2[which(sps_data2$match == 'fuzzy'), c('country', 'cname_used', 'match')]
```

Two additional columns are merged to the dataset:

* `cname_used`: the values of country names in the merging dataset (i.e., same as `countryvar`).
* `match`: tells you how each row was matched, either `exact` or `fuzzy`. 

### Descriptive Summary

The function ``desc_stat`` returns simple descriptive statistics, number of missing countries in each year, and correlation matrix. Highly correlated variables mean that they are capturing similar cross-country contexts, so you might want to considder dropping one of them in the SPS. Character and factor variables are automatically binarized to obtain descriptive statistics.

```{r}
desc <- desc_stat(data = sps_data)
```

<!-- Update the presentation, remove knitrExtra, try to use base R-->

```{r, echo = F}
# Descriptive Statistics
head(desc$desc, n = 3)

# Number of missing observations per year
head(desc$miss, n = 3)

# Correlation Matrix
round(desc$corr[1:3, 1:3], 3)
```

<!-- ### Creating a Map PASS ON TO SPSR --> 

<!-- For your selected countries, you can also use the function ``sps_map`` to create a world plot to show heterogeneity in selected covariates. For example, -->

<!-- ```{r, fig.fullwidth = TRUE, fig.width = 9, fig.height = 5} -->
<!-- sps_data2$target <- as.numeric(sps_data2$region %in% c('Europe & Central Asia', 'Latin America & Caribbean', 'North America')) -->
<!-- map <- sps_map(data = sps_data2,  -->
<!--                targetvar = 'target', -->
<!--                countryvar = 'iso3',  -->
<!--                countrysps = c('MEX', 'PRY', 'BOL', 'USA', 'FRA', 'NOR', 'HUN')) -->
<!-- map -->
<!-- ``` -->

# References

Michael Coppedge et al. 2023. “V-Dem Dataset V13.” Varieties of Democracy (V-Dem) Project. https://doi.org/10.23696/VDEMDS23.

University of Groningen. 2016. “World Languages.” University of Groningen Open Data. www.resourcewatch.org.
