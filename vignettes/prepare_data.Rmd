---
title: "Prepare Site-Level Variables with `spsRdata`"
output: 
  md_document:
    variant: markdown_github
always_allow_html: yes
---

The purpose of the R package `spsRdata` is to facilitate the selection of site-level variables for SPS. Users interested in a multi-country study can use the dataset `sps_country_data` provided in the package to select variables relevant for their research objective, after which they can implement SPS via `spsR` to select study sites. `spsRdata` also includes several functions that allows users to explore additional site-level variables and run simple descriptive analyses.

### Country-Level Dataset: `sps_country_data`

We provide a country-level site selection dataset (`sps_country_data`) comprised of 21 variables for 179 countries between 2015 and 2022. It contains variables representing political, economic, and social characteristics of countries collected from the following sources: 

* [Varieties of Democracy (V-Dem) project](https://v-dem.net/data/the-v-dem-dataset)
* [World Bank Indicators](https://datahelpdesk.worldbank.org/knowledgebase/articles/889392-about-the-indicators-api-documentation)
* [University of Groningen's World Languages](https://resourcewatch.org/data/explore/soc_071_world_languages?section=Discover&selectedCollection=&zoom=3&lat=0&lng=0&pitch=0&bearing=0&basemap=dark&labels=light&layers=%255B%257B%2522dataset%2522%253A%252220662342-dcdd-4a42-9f58-bcc80217de71%2522%252C%2522opacity%2522%253A1%252C%2522layer%2522%253A%2522f2d76e6b-060d-4dc9-83ea-284bef6b2aae%2522%257D%255D&aoi=&page=1&sort=most-viewed&sortDirection=-1)

`sps_country_data` includes the following variables: 

```{r, messages = F}
library(spsRdata)
library(spsR)

data(sps_country_data)
head(sps_country_data, n = 3)

data(codebook)
head(codebook, n = 3)
```

```{r, echo = F}
library(kableExtra)
library(knitr)
kbl(codebook,
      label = "tab:codebook",
      caption = "List of Selected Variables") %>%
  kable_classic_2(full_width = T) %>%
  kable_styling(font_size = 12, bootstrap_options = c('hover', 'condensed')) %>%
  column_spec(1, italic = T) %>%
  pack_rows('Key Identifiers', 1, 3) %>%
  pack_rows('Geographic Indicators', 4, 5) %>%
  pack_rows('Democracy Indicators', 6, 8) %>%
  pack_rows('Political Indicators', 9, 14) %>%
  pack_rows('Economic Indicators', 15, 16) %>%
  pack_rows('Sociodemographic Indicators', 17, 19) %>%
  pack_rows('Social Indicators', 20, 21)
```

### Example: Site-Selection Procedure 

We use a multi-country survey experiment by Naumann et al. (2018) to demonstrate how to use `sps_country_data` and various functions in `spsRdata`.

#### Select from `sps_country_data`

As mentioned in the introduction, we consider 7 site-level variables discussed in the original paper: GDP, size of migrant population, unemployment rates, general support for immigration, the proportion of female, the mean age, and the mean education. Two out of the 7 variables already exist in `sps_country_data`: GDP and unemployment rate. So we subset the dataset to include only those variables we're interested in diversifying:

```{r}
sps_country_data1 <- sps_country_data[, c('country', 'iso3', 'year', 'NY.GDP.MKTP.CD', 'SL.UEM.TOTL.ZS')]
```

#### Search for New Site-Level Variables

Users can also search for other site-level variables in V-Dem and World Bank using keywords via the function ``search_var``, which allows for a regex notation. Here, we look for data on size of migrant population:

```{r}
search_result <- search_var(keyword = 'international migrant')
head(search_result, n = 3)
```

Based on the search return, users can add variable(s) to the baseline dataset using ``add_var``. In our example, we're interested in adding `SM.POP.TOTL.ZS` that captures the proportion of migrant population:

```{r}
sps_country_data2 <- add_var(data = sps_country_data1, vars = c('SM.POP.TOTL.ZS'))
head(sps_country_data2, n = 3)
```

#### Merge External Dataset

Users can also merge their own dataset using ``merge_data``. In our example, general support for immigration, the proportion of female, the mean age, and the mean education come from European Social Survey:

<!-- Re-create with ESS dataset with country and year already created -->

```{r, echo = F}
naumann <- as.data.frame(X_Imm) %>% tibble::rownames_to_column() %>% dplyr::select(-GDP, -Unemp., -Immigration, -rowname) %>% dplyr::rename_all(tolower) 
naumann$cntry <- c("The Netherlands","Sweden","Norway","France","Germany","Bellgium","Denmark","Finland","Ireland","Slovenia","Spain","Switzerland","Austria","Czech","United Kingdom")
naumann$yr    <- 2015
naumann <- dplyr::select(naumann, cntry, yr, everything())
head(naumann)
```

<!-- Simplify the code in presenting the merged result -->
```{r}
sps_country_data2 <- merge_data(basedata = sps_country_data1, newdata = naumann, yearvar = 'yr', countryvar = 'cntry', iso = FALSE)

sps_country_data2[which(sps_country_data2$match == 'fuzzy'), c('country', 'cname_used', 'match')]
```


If the user's dataset has an ISO3 country code, it merges the dataset to the `sps_country_data` using the ISO3 code only. If your dataset has a country name variable instead, it first merges via an exact match based on the country name, followed by a [fuzzy-match](https://github.com/dgrtwo/fuzzyjoin). For example, 

Two additional columns are merged to the dataset:

* `cname_used`: the values of country names in the merging dataset (i.e., same as `countryvar`).
* `match`: tells you how each row was matched, either `exact` or `fuzzy`. 

### Descriptive Summary

The function ``desc_stat`` returns simple descriptive statistics, number of missing countries in each year, and correlation matrix. Highly correlated variables mean that they are capturing similar cross-country contexts, so you might want to considder dropping one of them in the SPS. Character and factor variables are automatically binarized to obtain descriptive statistics.

```{r}
desc <- desc_stat(data = sps_country_data)

# Descriptive Statistics
head(desc$desc, n = 3)

# Number of missing observations per year
head(desc$miss, n = 3)

# Correlation Matrix
round(desc$corr[1:3, 1:3], 3)
```

# References

Michael Coppedge et al. 2023. “V-Dem Dataset V13.” Varieties of Democracy (V-Dem) Project. https://doi.org/10.23696/VDEMDS23.

University of Groningen. 2016. “World Languages.” University of Groningen Open Data. www.resourcewatch.org.
